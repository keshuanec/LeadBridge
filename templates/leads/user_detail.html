{% extends "base.html" %}

{% block title %}Detail uživatele{% endblock %}

{% block content %}
<div class="card">
    <h2>Detail uživatele</h2>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start;">
        <div>
            <p><strong>Jméno:</strong> {{ viewed_user.get_full_name }}</p>

            <p><strong>E-mail:</strong> {{ viewed_user.email|default:"—" }}</p>

            <p><strong>Telefon:</strong> {{ viewed_user.phone|default:"—" }}</p>

            <p><strong>Role:</strong> {{ viewed_user.get_role_display }}</p>

            {% if user == viewed_user %}
            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #ddd; display: flex; gap: 12px;">
                <a href="{% url 'edit_profile' %}" class="btn btn-primary">Upravit údaje</a>
                <a href="{% url 'change_password' %}" class="btn btn-secondary">Změnit heslo</a>
            </div>
            {% endif %}
        </div>

        {# Odkazy na leady/obchody s filtry #}
        {% if viewed_user.role == "ADVISOR" or viewed_user.role == "REFERRER" or viewed_user.role == "REFERRER_MANAGER" or viewed_user.role == "OFFICE" or referrer_profile %}
        <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-top: 0; font-size: 16px;">Rychlé odkazy</h3>

            {# Pro doporučitele (všichni kromě čistých advisorů bez referrer_profile) #}
            {% if referrer_profile or viewed_user.role == "REFERRER" or viewed_user.role == "REFERRER_MANAGER" or viewed_user.role == "OFFICE" %}
            <div style="margin-bottom: 12px;">
                <strong>Jako doporučitel:</strong>
                <a href="{% url 'my_leads' %}?referrer={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 8px;">Leady</a>
                <a href="{% url 'deals_list' %}?referrer={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 4px;">Obchody</a>
            </div>
            {% endif %}

            {# Pro advisora - leady/obchody kde je advisor #}
            {% if viewed_user.role == "ADVISOR" %}
            <div style="margin-bottom: 12px;">
                <strong>Jako poradce:</strong>
                <a href="{% url 'my_leads' %}?advisor={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 8px;">Leady</a>
                <a href="{% url 'deals_list' %}?advisor={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 4px;">Obchody</a>
            </div>
            {% endif %}

            {# Pro manažera - leady/obchody jeho týmu #}
            {% if viewed_user.role == "REFERRER_MANAGER" %}
            <div style="margin-bottom: 12px;">
                <strong>Tým manažera:</strong>
                <a href="{% url 'my_leads' %}?manager={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 8px;">Leady týmu</a>
                <a href="{% url 'deals_list' %}?manager={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 4px;">Obchody týmu</a>
            </div>
            {% endif %}

            {# Pro kancelář - leady/obchody její kanceláře #}
            {% if viewed_user.role == "OFFICE" %}
            <div style="margin-bottom: 12px;">
                <strong>Kancelář:</strong>
                <a href="{% url 'my_leads' %}?office={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 8px;">Leady kanceláře</a>
                <a href="{% url 'deals_list' %}?office={{ viewed_user.pk }}" class="btn btn-sm" style="margin-left: 4px;">Obchody kanceláře</a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <hr>

{% include "leads/includes/date_filter.html" %}

    {% if manager %}
    <p><strong>Manažer:</strong>
        <a href="{% url 'user_detail' manager.pk %}">{{ manager.get_full_name }}</a>
    </p>
    {% endif %}

    {% if office %}
    <p><strong>Kancelář:</strong> {{ office.name }}
        {% if office.owner %}
            (<a href="{% url 'user_detail' office.owner.pk %}">{{ office.owner.get_full_name }}</a>)
        {% endif %}
    </p>
    {% endif %}

    {% if referrer_profile %}
    <p><strong>Přiřazení poradci:</strong>
        {% for advisor in referrer_profile.advisors.all %}
            <a href="{% url 'advisor_detail' advisor.pk %}">{{ advisor.get_full_name }}</a>{% if not forloop.last %}, {% endif %}
        {% empty %}
            —
        {% endfor %}
    </p>
    {% endif %}

    {% if advisor_stats %}
    <hr>
    <h3>Statistiky jako poradce</h3>
    <table>
        <tbody>
            <tr>
                <th>Obdržené leady</th>
                <td>{{ advisor_stats.leads_received }}</td>
            </tr>
            <tr>
                <th>Domluvené schůzky</th>
                <td>{{ advisor_stats.meetings_planned }}</td>
            </tr>
            <tr>
                <th>Realizované schůzky</th>
                <td>{{ advisor_stats.meetings_done }}</td>
            </tr>
            <tr>
                <th>Založené obchody</th>
                <td>{{ advisor_stats.deals_created }}</td>
            </tr>
            <tr>
                <th>Dokončené obchody</th>
                <td>{{ advisor_stats.deals_completed }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {% if office_stats %}
    <hr>
    <h3>Statistiky kanceláře</h3>
    <table>
        <tbody>
            <tr>
                <th>Předané leady</th>
                <td>{{ office_stats.leads_sent }}</td>
            </tr>
            <tr>
                <th>Domluvené schůzky</th>
                <td>{{ office_stats.meetings_planned }}</td>
            </tr>
            <tr>
                <th>Realizované schůzky</th>
                <td>{{ office_stats.meetings_done }}</td>
            </tr>
            <tr>
                <th>Dokončené obchody</th>
                <td>{{ office_stats.deals_done }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {% if team_stats %}
    <hr>
    <h3>
        {% if viewed_user.role == "REFERRER_MANAGER" %}
            Statistiky týmu
        {% elif viewed_user.role == "OFFICE" %}
            Statistiky týmu (jako manažer)
        {% endif %}
    </h3>
    <table>
        <tbody>
            <tr>
                <th>Předané leady</th>
                <td>{{ team_stats.leads_sent }}</td>
            </tr>
            <tr>
                <th>Domluvené schůzky</th>
                <td>{{ team_stats.meetings_planned }}</td>
            </tr>
            <tr>
                <th>Realizované schůzky</th>
                <td>{{ team_stats.meetings_done }}</td>
            </tr>
            <tr>
                <th>Dokončené obchody</th>
                <td>{{ team_stats.deals_done }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {% if referrer_stats %}
    <hr>
    <h3>Statistiky jako doporučitel</h3>
    <table>
        <tbody>
            <tr>
                <th>Předané leady</th>
                <td>{{ referrer_stats.leads_sent }}</td>
            </tr>
            <tr>
                <th>Domluvené schůzky</th>
                <td>{{ referrer_stats.meetings_planned }}</td>
            </tr>
            <tr>
                <th>Realizované schůzky</th>
                <td>{{ referrer_stats.meetings_done }}</td>
            </tr>
            <tr>
                <th>Dokončené obchody</th>
                <td>{{ referrer_stats.deals_done }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    <div style="margin-top: 24px;">
        <a href="javascript:history.back()" class="btn btn-secondary">← Zpět</a>
    </div>
</div>
{% endblock %}
