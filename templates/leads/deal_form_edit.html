{% extends "base.html" %}
{% block title %}Upravit obchod{% endblock %}

{% block content %}
<div class="card" style="max-width: 700px; margin: 0 auto;">
    <h2>Upravit obchod – {{ deal.client_name }}</h2>

    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label>{{ form.client_name.label }}</label>
            {{ form.client_name }}
        </div>
        <div class="form-group">
            <label>{{ form.client_phone.label }}</label>
            {{ form.client_phone }}
        </div>
        <div class="form-group">
            <label>{{ form.client_email.label }}</label>
            {{ form.client_email }}
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

        <div class="form-group">
            <label>{{ form.loan_amount.label }}</label>
            {{ form.loan_amount }}
        </div>
        <div class="form-group">
            <label>{{ form.bank.label }}</label>
            {{ form.bank }}
        </div>
        <div class="form-group">
            <label>{{ form.property_type.label }}</label>
            {{ form.property_type }}
        </div>
        <div class="form-group">
            <label>{{ form.status.label }}</label>
            {{ form.status }}
        </div>

        <div id="extra-note-wrapper" class="form-group" style="display: none;">
            <label for="{{ form.extra_note.id_for_label }}">Poznámka ke změně</label>
            {{ form.extra_note }}
            {% if form.extra_note.errors %}
                <div class="alert alert-error">{{ form.extra_note.errors }}</div>
            {% endif %}
            <small>Volitelné – pokud vyplníš, uloží se jako běžná poznámka k leadu.</small>
        </div>

        <button type="submit" class="btn btn-primary">Uložit změny</button>
        <a href="{% url 'deal_detail' deal.pk %}" class="btn btn-secondary" style="margin-left:10px;">Zrušit</a>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusField = document.getElementById("{{ form.status.id_for_label }}");
    const wrapper = document.getElementById("extra-note-wrapper");

    if (statusField && wrapper) {
        const originalValue = "{{ form.initial.status|default_if_none:'' }}";

        function checkChanges() {
            // Zobrazíme wrapper, pokud se změnil stav
            if (statusField.value && statusField.value !== originalValue) {
                wrapper.style.display = "block";
            } else {
                wrapper.style.display = "none";
            }
        }

        statusField.addEventListener("change", checkChanges);
        checkChanges(); // Spustit při načtení
    }
});
</script>
{% endblock %}
