{% extends "base.html" %}

{% block title %}Moje leady{% endblock %}

{% block content %}
<style>
    /* Kompaktní sloupce v tabulce leadů */
    .table-wrapper {
        overflow-x: auto;
        transition: all 0.3s ease;
    }

    .table-wrapper > table.leads-table {
        table-layout: fixed !important;
        width: 100% !important;
        transition: width 0.3s ease;
    }

    .table-wrapper > table.leads-table.notes-visible {
        width: calc(100% + 400px) !important;
    }

    /* Sloupec Poznámka */
    .table-wrapper > table.leads-table .note-col {
        transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
        vertical-align: top !important;
        max-width: 400px !important;
        overflow: hidden !important;
    }

    .table-wrapper > table.leads-table .note-col.note-col-hidden {
        width: 0 !important;
        padding: 0 !important;
        opacity: 0;
        border: none !important;
    }

    .table-wrapper > table.leads-table .note-col:not(.note-col-hidden) {
        width: 400px !important;
        padding: 6px 8px !important;
        opacity: 1;
    }

    /* Vnitřní div pro oříznutí textu poznámky */
    .table-wrapper > table.leads-table .note-col .note-content {
        font-size: 12px !important;
        line-height: 1.3 !important;
        max-height: 2.6em !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        width: 100% !important;
    }

    /* Kompaktní řádky tabulky - max 2 řádky textu */
    .table-wrapper > table.leads-table td {
        font-size: 13px !important;
        padding: 6px 8px !important;
        white-space: normal !important;
        line-height: 1.3 !important;
        vertical-align: top !important;
    }

    .table-wrapper > table.leads-table th {
        font-size: 12px !important;
        padding: 8px 8px !important;
        white-space: normal !important;
        line-height: 1.3 !important;
    }

    /* Sloupec klient */
    .table-wrapper > table.leads-table .client-col {
        width: 90px !important;
        white-space: normal !important;
        padding: 6px 8px !important;
        line-height: 1.3 !important;
    }

    /* Sloupce s jmény osob (Doporučitel, Poradce, Manažer, Kancelář) */
    .table-wrapper > table.leads-table .person-col {
        width: 70px !important;
        white-space: normal !important;
        font-size: 13px !important;
        padding: 6px 8px !important;
        line-height: 1.3 !important;
    }

    /* Sloupec Stav komunikace */
    .table-wrapper > table.leads-table .status-col {
        width: 85px !important;
        white-space: normal !important;
        padding: 6px 4px !important;
        line-height: 1.3 !important;
        overflow: hidden !important;
    }

    .table-wrapper > table.leads-table .status-col .badge {
        font-size: 10px !important;
        padding: 3px 5px !important;
        white-space: normal !important;
    }

    /* Sloupec Vytvořeno */
    .table-wrapper > table.leads-table .date-col {
        width: 85px !important;
        white-space: nowrap !important;
    }
</style>

<div class="card">
    <h2>Moje leady</h2>

{# Tlačítka pro zobrazení filtrů a poznámek + akční tlačítka filtrů #}
<div class="toggle-buttons-row">
    <button type="button" class="btn btn-secondary filters-toggle">Zobrazit filtry</button>
    <button type="button" class="btn btn-secondary" id="toggleNotesBtn">Zobrazit poznámky</button>
    <button type="button" class="btn btn-primary filter-submit-btn" style="display: none;">Filtrovat</button>
    {% if current_status or current_referrer or current_advisor or current_manager or current_office %}
    <a href="{% url 'my_leads' %}" class="btn btn-secondary filter-reset-btn">Zrušit filtry</a>
    {% endif %}
</div>

{# Filtry POD tlačítky #}
<form method="get" class="filter-form" id="filterForm">
    <div class="filters-content">
    {% if "status" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Stav</label>
            <select name="status">
                <option value="">– všechny –</option>
                {% for code, label in status_choices %}
                    <option value="{{ code }}" {% if current_status == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "referrer" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Doporučitel</label>
            <select name="referrer">
                <option value="">– všichni –</option>
                {% for r in referrer_options %}
                    <option value="{{ r.id }}" {% if current_referrer == r.id|stringformat:"s" %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {# Poradce: zobrazit jen pokud je povolený filtrem a zároveň dává smysl sloupec #}
    {% if "advisor" in allowed and show_advisor_col %}
        <div>
            <label style="font-size:12px; display:block;">Poradce</label>
            <select name="advisor">
                <option value="">– všichni –</option>
                {% for a in advisor_options %}
                    <option value="{{ a.id }}" {% if current_advisor == a.id|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "manager" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Manažer</label>
            <select name="manager">
                <option value="">– všichni –</option>
                <option value="__none__" {% if current_manager == "__none__" %}selected{% endif %}>— bez manažera —</option>
                {% for m in manager_options %}
                    <option value="{{ m.id }}" {% if current_manager == m.id|stringformat:"s" %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "office" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Kancelář</label>
            <select name="office">
                <option value="">– všechny –</option>
                <option value="__none__" {% if current_office == "__none__" %}selected{% endif %}>— bez kanceláře —</option>
                {% for o in office_options %}
                    <option value="{{ o.id }}" {% if current_office == o.id|stringformat:"s" %}selected{% endif %}>{{ o.name }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <input type="hidden" name="sort" value="{{ current_sort }}">
    <input type="hidden" name="dir" value="{{ current_dir }}">
    </div>
</form>

{# Výsledky #}
{% if leads %}
    <div class="table-wrapper">
    <table class="leads-table">
        <thead>
        <tr>
            <th class="client-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=client&dir={% if current_sort == 'client' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Klient
                    {% if current_sort == 'client' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>

            <th class="note-col note-col-hidden">Poznámka</th>

            {% if show_referrer_col %}
            <th class="person-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=referrer&dir={% if current_sort == 'referrer' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Doporučitel
                    {% if current_sort == 'referrer' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            {% endif %}

            {% if show_advisor_col %}
            <th class="person-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=advisor&dir={% if current_sort == 'advisor' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Poradce
                    {% if current_sort == 'advisor' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            {% endif %}

            {% if show_manager_col %}
            <th class="person-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=manager&dir={% if current_sort == 'manager' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Manažer
                    {% if current_sort == 'manager' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            {% endif %}

            {% if show_office_col %}
            <th class="person-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=office&dir={% if current_sort == 'office' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Kancelář
                    {% if current_sort == 'office' %}
                        {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            {% endif %}

            <th class="status-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=comm_status&dir={% if current_sort == 'comm_status' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Stav komunikace
                    {% if current_sort == 'comm_status' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>

            <th class="date-col">
                <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=created_at&dir={% if current_sort == 'created_at' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Vytvořeno
                    {% if current_sort == 'created_at' %}
                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
        </tr>
        </thead>
        <tbody>
        {% for lead in leads %}
        <tr>
            <td class="client-col">
                <a href="{% url 'lead_detail' lead.pk %}">
                    {{ lead.client_name }}
                </a><br>
                {% if lead.client_phone %}
                <small>{{ lead.client_phone }}</small>
                {% endif %}
            </td>

            <td class="note-col note-col-hidden">
                <div class="note-content">
                    {% if lead.last_note_text %}
                        {{ lead.last_note_text }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </td>

            {% if show_referrer_col %}
            <td class="person-col">
                {% if lead.referrer %}
                    <a href="{% url 'user_detail' lead.referrer.pk %}">{{ lead.referrer }}</a>
                {% else %}
                    —
                {% endif %}
            </td>
            {% endif %}

            {% if show_advisor_col %}
            <td class="person-col">
                {% if lead.advisor %}
                    <a href="{% url 'advisor_detail' lead.advisor.pk %}">{{ lead.advisor }}</a>
                {% else %}
                    —
                {% endif %}
            </td>
            {% endif %}

            {% if show_manager_col %}
            <td class="person-col">
                {% if lead.is_personal_contact %}
                    <span style="color: #666; font-style: italic;">Vlastní kontakt</span>
                {% elif lead.referrer_manager %}
                    <a href="{% url 'user_detail' lead.referrer_manager.pk %}">{{ lead.referrer_manager }}</a>
                {% else %}
                    —
                {% endif %}
            </td>
            {% endif %}

            {% if show_office_col %}
            <td class="person-col">
                {% if lead.is_personal_contact %}
                    <span style="color: #666; font-style: italic;">Vlastní kontakt</span>
                {% elif lead.referrer.referrer_profile.manager.manager_profile.office %}
                    {% with office=lead.referrer.referrer_profile.manager.manager_profile.office %}
                        {% if office.owner %}
                            <a href="{% url 'user_detail' office.owner.pk %}">{{ office.name }}</a>
                        {% else %}
                            {{ office.name }}
                        {% endif %}
                    {% endwith %}
                {% else %}
                    —
                {% endif %}
            </td>
            {% endif %}

            <td class="status-col"><span class="badge">{{ lead.get_communication_status_display }}</span></td>
            <td class="date-col">{{ lead.created_at|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    {% if qs_keep or current_status or current_referrer or current_advisor or current_manager or current_office %}
        <p>Pro zvolené filtry nebyly nalezeny žádné leady.</p>
    {% else %}
        {% if user.role == "OFFICE" %}
            <p>Vaše kancelář zatím nemá žádné leady.</p>
        {% else %}
            <p>Nemáš zatím žádné leady.</p>
        {% endif %}
    {% endif %}
{% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggleNotesBtn');
    const noteCols = document.querySelectorAll('.note-col');
    const leadsTable = document.querySelector('.leads-table');
    let notesVisible = false;

    if (toggleBtn && leadsTable) {
        toggleBtn.addEventListener('click', function() {
            notesVisible = !notesVisible;

            noteCols.forEach(function(col) {
                if (notesVisible) {
                    col.classList.remove('note-col-hidden');
                } else {
                    col.classList.add('note-col-hidden');
                }
            });

            if (notesVisible) {
                leadsTable.classList.add('notes-visible');
            } else {
                leadsTable.classList.remove('notes-visible');
            }

            toggleBtn.textContent = notesVisible ? 'Skrýt poznámky' : 'Zobrazit poznámky';
        });
    }
});
</script>
{% endblock %}
