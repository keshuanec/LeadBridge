{% extends "base.html" %}

{% block title %}Moje leady{% endblock %}

{% block content %}
<div class="card">
    <h2>Moje leady</h2>

    {% if can_create_leads %}
        <p>
            <a href="{% url 'lead_create' %}">+ Nový lead</a>
        </p>
    {% endif %}

    {% if leads %}
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="?sort=client&dir={% if current_sort == 'client' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Klient
                            {% if current_sort == 'client' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    <th>
                        <a href="?sort=referrer&dir={% if current_sort == 'referrer' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Doporučitel
                            {% if current_sort == 'referrer' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    <th>
                        <a href="?sort=advisor&dir={% if current_sort == 'advisor' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Poradce
                            {% if current_sort == 'advisor' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    {% if user.role == "OFFICE" or user.role == "ADVISOR" %}
                        <th>
                            <a href="?sort=manager&dir={% if current_sort == 'manager' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                Manažer
                                {% if current_sort == 'manager' %}
                                    {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                    {% endif %}

                    <th>
                        <a href="?sort=comm_status&dir={% if current_sort == 'comm_status' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Stav komunikace
                            {% if current_sort == 'comm_status' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    <th>
                        <a href="?sort=commission&dir={% if current_sort == 'commission' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Stav provize
                            {% if current_sort == 'commission' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    <th>
                        <a href="?sort=created_at&dir={% if current_sort == 'created_at' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Vytvořeno
                            {% if current_sort == 'created_at' %}
                                {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
            {% for lead in leads %}
                <tr>
                    <td>
                        <a href="{% url 'lead_detail' lead.pk %}">
                            {{ lead.client_name }}
                        </a><br>
                        {% if lead.client_phone %}
                            <small>{{ lead.client_phone }}</small><br>
                        {% endif %}
                        {% if lead.client_email %}
                            <small>{{ lead.client_email }}</small>
                        {% endif %}
                    </td>
                    <td>{{ lead.referrer }}</td>
                    <td>{{ lead.advisor|default:"—" }}</td>

                    {% if user.role == "OFFICE" or user.role == "ADVISOR" %}
                        <td>
                            {{ lead.referrer_manager|default:"—" }}
                        </td>
                    {% endif %}

                    <td><span class="badge">{{ lead.get_communication_status_display }}</span></td>
                    <td><span class="badge">{{ lead.get_commission_status_display }}</span></td>
                    <td>{{ lead.created_at|date:"d.m.Y H:i" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        {% if user.role == "OFFICE" %}
            <p>Vaše kancelář zatím nemá žádné leady.</p>
        {% else %}
            <p>Nemáš zatím žádné leady.</p>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
