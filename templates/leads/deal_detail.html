{% extends "base.html" %}
{% block title %}Detail obchodu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ deal.client_name }}</h2>

    <p><strong>Telefon:</strong> {{ deal.client_phone|default:"‚Äî" }}</p>
    <p><strong>E-mail:</strong> {{ deal.client_email|default:"‚Äî" }}</p>

    <!-- Typ obchodu -->
    <p>
        <strong>Typ obchodu:</strong>
        {% if deal.is_personal_deal %}
            <span class="badge" style="background-color: #4a90e2; color: white;">üë§ Vlastn√≠ obchod (bez provize)</span>
        {% else %}
            <span class="badge" style="background-color: #50c878; color: white;">üíº Provizovan√Ω obchod</span>
        {% endif %}
    </p>

    <!-- Pokud m√° lead v√≠ce deal≈Ø, zobraz info -->
    {% if lead.deals.count > 1 %}
    <div class="alert alert-info" style="margin: 15px 0; padding: 12px; background-color: #e7f3ff; border-left: 3px solid #2196F3;">
        <strong>‚ÑπÔ∏è Tento klient m√° celkem {{ lead.deals.count }} obchod{% if lead.deals.count > 1 %}y{% endif %}.</strong>
        <ul style="margin-top: 10px; margin-bottom: 0;">
            {% for other_deal in lead.deals.all %}
                {% if other_deal.pk != deal.pk %}
                <li>
                    <a href="{% url 'deal_detail' other_deal.pk %}">
                        {{ other_deal.get_bank_display }} - {{ other_deal.loan_amount|intcomma }} Kƒç
                        ({{ other_deal.get_status_display }})
                        {% if other_deal.is_personal_deal %}
                            <span class="badge" style="background-color: #4a90e2; color: white;">üë§ Vlastn√≠</span>
                        {% endif %}
                    </a>
                </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if show_referrer %}
        <p><strong>Doporuƒçitel:</strong>
            {% if lead.referrer.role == "ADVISOR" %}
                <a href="{% url 'advisor_detail' lead.referrer.pk %}">{{ lead.referrer }}</a>
            {% else %}
                <a href="{% url 'user_detail' lead.referrer.pk %}">{{ lead.referrer }}</a>
            {% endif %}
        </p>
    {% endif %}
    {% if lead.is_personal_contact %}
        <p><strong>Typ kontaktu:</strong> <span style="color: #666; font-style: italic;">Vlastn√≠ kontakt</span></p>
    {% else %}
        {% if lead.referrer_manager %}
            <p><strong>Mana≈æer:</strong> <a href="{% url 'user_detail' lead.referrer_manager.pk %}">{{ lead.referrer_manager }}</a></p>
        {% endif %}
        {% if lead.referrer_office and lead.referrer_office.owner %}
            <p><strong>Kancel√°≈ô:</strong> {{ lead.referrer_office.name }}
                (<a href="{% url 'user_detail' lead.referrer_office.owner.pk %}">{{ lead.referrer_office.owner }}</a>)
            </p>
        {% endif %}
    {% endif %}

    <hr>

    <p><strong>V√Ω≈°e √∫vƒõru:</strong> {{ deal.loan_amount }} Kƒç</p>
    <p><strong>Banka:</strong> {{ deal.get_bank_display }}</p>
    {% if not lead.is_personal_contact %}
        <p><strong>Nemovitost:</strong> {{ deal.get_property_type_display }}</p>
    {% endif %}
    <p><strong>Stav obchodu:</strong> <span class="badge">{{ deal.get_status_display }}</span></p>

    {% if not lead.is_personal_contact %}
        <hr>

        {# Zobrazen√≠ proviz√≠ - role-based #}
        <p><strong>Provize makl√©≈ôe:</strong> {{ deal.calculated_commission_referrer }} Kƒç</p>

        {% if user.role != "REFERRER" and deal.calculated_commission_manager > 0 %}
            <p><strong>Provize mana≈æera:</strong> {{ deal.calculated_commission_manager }} Kƒç</p>
        {% endif %}

        {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
            {% if deal.calculated_commission_office > 0 %}
                <p><strong>Provize kancel√°≈ôe:</strong> {{ deal.calculated_commission_office }} Kƒç</p>
            {% endif %}
        {% endif %}

        {# Provize celkem - jen pro OFFICE, ADVISOR, superuser #}
        {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
            <p><strong>Provize celkem:</strong> {{ deal.calculated_commission_total }} Kƒç</p>
        {% endif %}

        {# Provize poradce - jen pro ADVISOR a superuser #}
        {% if user.role == "ADVISOR" or user.is_superuser %}
            {% if deal.calculated_commission_advisor > 0 %}
                <p><strong>Provize poradce ({{ deal.lead.advisor }}):</strong> {{ deal.calculated_commission_advisor }} Kƒç</p>
            {% endif %}
        {% endif %}

        <hr>

        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <a href="{% url 'deal_edit' deal.pk %}" class="btn btn-secondary" title="Upravit obchod">‚úèÔ∏è Upravit obchod</a>

            {% if can_manage_commission %}
                {% if deal.commission_status != "READY" and deal.commission_status != "PAID" and deal.status in "SIGNED,SIGNED_NO_PROPERTY,DRAWN" %}
                    <form method="post" action="{% url 'deal_commission_ready' deal.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">‚úÖ P≈ôipraveno k vyplacen√≠</button>
                    </form>
                {% endif %}

                {% if deal.commission_status == "READY" or deal.commission_status == "PAID" %}
                    {% if deal.paid_referrer %}
                        <span class="badge badge-ready" title="Makl√©≈ô byl vyplacen">‚úÖ Vyplaceno makl√©≈ôi</span>
                    {% else %}
                        <form method="post" action="{% url 'deal_commission_paid' deal.pk 'referrer' %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">üí∏ Vyplaceno makl√©≈ôi</button>
                        </form>
                    {% endif %}

                    {% if has_manager %}
                        {% if deal.paid_manager %}
                            <span class="badge badge-ready" title="Mana≈æer byl vyplacen">‚úÖ Vyplaceno mana≈æerovi</span>
                        {% else %}
                            <form method="post" action="{% url 'deal_commission_paid' deal.pk 'manager' %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">üí∏ Vyplaceno mana≈æerovi</button>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if has_office %}
                        {% if deal.paid_office %}
                            <span class="badge badge-ready" title="Kancel√°≈ô byla vyplacena">‚úÖ Vyplaceno kancel√°≈ôi</span>
                        {% else %}
                            <form method="post" action="{% url 'deal_commission_paid' deal.pk 'office' %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">üí∏ Vyplaceno kancel√°≈ôi</button>
                            </form>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    {% else %}
        <hr>

        {# Provize poradce pro vlastn√≠ kontakty - jen pro ADVISOR a superuser #}
        {% if user.role == "ADVISOR" or user.is_superuser %}
            {% if deal.calculated_commission_advisor > 0 %}
                <p><strong>Provize poradce ({{ deal.lead.advisor }}):</strong> {{ deal.calculated_commission_advisor }} Kƒç</p>
            {% endif %}

            {# Meziprovize nad≈ô√≠zen√©ho poradce (Typ 3) - i pro vlastn√≠ kontakty #}
            {% if deal.calculated_commission_advisor_manager > 0 %}
                <p><strong>Meziprovize mana≈æera ({{ deal.lead.advisor.advisor_manager }}):</strong> {{ deal.calculated_commission_advisor_manager }} Kƒç</p>
            {% endif %}

            {% if deal.calculated_commission_advisor > 0 or deal.calculated_commission_advisor_manager > 0 %}
                <hr>
            {% endif %}
        {% endif %}

        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <a href="{% url 'deal_edit' deal.pk %}" class="btn btn-secondary" title="Upravit obchod">‚úèÔ∏è Upravit obchod</a>
        </div>
    {% endif %}

    <hr style="margin:16px 0;">

    <h3>P≈ôidat pozn√°mku</h3>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            {{ note_form.text }}
        </div>
        <div class="form-group" style="margin-top:10px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                {{ note_form.is_private }}
                <span>{{ note_form.is_private.label }}</span>
            </label>
        </div>
        <button type="submit" class="btn btn-primary">P≈ôidat pozn√°mku</button>
    </form>

    <hr style="margin:16px 0;">

    <h3>Pozn√°mky</h3>
    {% if notes %}
        {% for note in notes %}
            <div class="card" style="box-shadow:none; border:1px solid #eee;{% if note.is_private %}background-color:#FFF9E6;border-left:3px solid #F39C12;{% endif %}">
                <strong>{{ note.author|default:"‚Äî" }}</strong>
                <small> ‚Äì {{ note.created_at|date:"d.m.Y H:i" }}</small>
                {% if note.is_private %}
                    <span style="color:#F39C12;font-weight:600;margin-left:8px;">üîí Soukrom√°</span>
                {% endif %}
                <div style="margin-top:6px;">{{ note.text|linebreaksbr }}</div>
            </div>
        {% endfor %}
    {% else %}
        <p>≈Ω√°dn√© pozn√°mky.</p>
    {% endif %}

    <hr style="margin:16px 0;">

    <h3>Historie</h3>
    {% if history %}
        <ul>
            {% for h in history %}
                <li>
                    <strong>{{ h.get_event_type_display }}</strong>
                    ‚Äì {{ h.created_at|date:"d.m.Y H:i" }}
                    {% if h.user %} ({{ h.user }}){% endif %}
                    {% if h.description %}<br><small>{{ h.description }}</small>{% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>≈Ω√°dn√° historie.</p>
    {% endif %}
</div>
{% endblock %}
