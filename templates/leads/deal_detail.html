{% extends "base.html" %}
{% block title %}Detail obchodu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ deal.client_name }}</h2>

    <p><strong>Telefon:</strong> {{ deal.client_phone|default:"‚Äî" }}</p>
    <p><strong>E-mail:</strong> {{ deal.client_email|default:"‚Äî" }}</p>

    {% if show_referrer %}
        <p><strong>Doporuƒçitel:</strong> {{ lead.referrer }}</p>
    {% endif %}
    {% if show_manager %}
        <p><strong>Mana≈æer:</strong> {{ lead.referrer_manager|default:"‚Äî" }}</p>
    {% endif %}
    {% if show_office %}
        <p><strong>Kancel√°≈ô:</strong> {{ lead.referrer_office|default:"‚Äî" }}</p>
    {% endif %}

    <hr>

    <p><strong>V√Ω≈°e √∫vƒõru:</strong> {{ deal.loan_amount }} Kƒç</p>
    <p><strong>Banka:</strong> {{ deal.get_bank_display }}</p>
    <p><strong>Nemovitost:</strong> {{ deal.get_property_type_display }}</p>
    <p><strong>Stav obchodu:</strong> <span class="badge">{{ deal.get_status_display }}</span></p>

    <hr>

    {# Zobrazen√≠ proviz√≠ - role-based #}
    <p><strong>Provize makl√©≈ôe:</strong> {{ deal.calculated_commission_referrer }} Kƒç</p>

    {% if user.role != "REFERRER" and deal.calculated_commission_manager > 0 %}
        <p><strong>Provize mana≈æera:</strong> {{ deal.calculated_commission_manager }} Kƒç</p>
    {% endif %}

    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
        {% if deal.calculated_commission_office > 0 %}
            <p><strong>Provize kancel√°≈ôe:</strong> {{ deal.calculated_commission_office }} Kƒç</p>
        {% endif %}
    {% endif %}

    {# Provize celkem - jen pro OFFICE, ADVISOR, superuser #}
    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
        <p><strong>Provize celkem:</strong> {{ deal.calculated_commission_total }} Kƒç</p>
    {% endif %}

    <hr>

    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <a href="{% url 'deal_edit' deal.pk %}" class="btn btn-secondary" title="Upravit obchod">‚úèÔ∏è Upravit obchod</a>

        {% if can_manage_commission %}
            {% if deal.commission_status != "READY" and deal.commission_status != "PAID" and deal.status in "SIGNED,SIGNED_NO_PROPERTY,DRAWN" %}
                <form method="post" action="{% url 'deal_commission_ready' deal.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">‚úÖ P≈ôipraveno k vyplacen√≠</button>
                </form>
            {% endif %}

            {% if deal.commission_status == "READY" or deal.commission_status == "PAID" %}
                {% if deal.paid_referrer %}
                    <span class="badge badge-ready" title="Makl√©≈ô byl vyplacen">‚úÖ Vyplaceno makl√©≈ôi</span>
                {% else %}
                    <form method="post" action="{% url 'deal_commission_paid' deal.pk 'referrer' %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">üí∏ Vyplaceno makl√©≈ôi</button>
                    </form>
                {% endif %}

                {% if has_manager %}
                    {% if deal.paid_manager %}
                        <span class="badge badge-ready" title="Mana≈æer byl vyplacen">‚úÖ Vyplaceno mana≈æerovi</span>
                    {% else %}
                        <form method="post" action="{% url 'deal_commission_paid' deal.pk 'manager' %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">üí∏ Vyplaceno mana≈æerovi</button>
                        </form>
                    {% endif %}
                {% endif %}

                {% if has_office %}
                    {% if deal.paid_office %}
                        <span class="badge badge-ready" title="Kancel√°≈ô byla vyplacena">‚úÖ Vyplaceno kancel√°≈ôi</span>
                    {% else %}
                        <form method="post" action="{% url 'deal_commission_paid' deal.pk 'office' %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">üí∏ Vyplaceno kancel√°≈ôi</button>
                        </form>
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
    </div>

    <hr style="margin:16px 0;">

    <h3>P≈ôidat pozn√°mku</h3>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            {{ note_form.text }}
        </div>
        <button type="submit" class="btn btn-primary">P≈ôidat pozn√°mku</button>
    </form>

    <hr style="margin:16px 0;">

    <h3>Pozn√°mky</h3>
    {% if notes %}
        {% for note in notes %}
            <div class="card" style="box-shadow:none; border:1px solid #eee;">
                <strong>{{ note.author|default:"‚Äî" }}</strong>
                <small> ‚Äì {{ note.created_at|date:"d.m.Y H:i" }}</small>
                <div style="margin-top:6px;">{{ note.text|linebreaksbr }}</div>
            </div>
        {% endfor %}
    {% else %}
        <p>≈Ω√°dn√© pozn√°mky.</p>
    {% endif %}

    <hr style="margin:16px 0;">

    <h3>Historie</h3>
    {% if history %}
        <ul>
            {% for h in history %}
                <li>
                    <strong>{{ h.get_event_type_display }}</strong>
                    ‚Äì {{ h.created_at|date:"d.m.Y H:i" }}
                    {% if h.user %} ({{ h.user }}){% endif %}
                    {% if h.description %}<br><small>{{ h.description }}</small>{% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>≈Ω√°dn√° historie.</p>
    {% endif %}
</div>
{% endblock %}
