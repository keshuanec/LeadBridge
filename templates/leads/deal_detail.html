{% extends "base.html" %}
{% block title %}Detail obchodu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ deal.client_name }}</h2>

    <p><strong>Telefon:</strong> {{ deal.client_phone|default:"‚Äî" }}</p>
    <p><strong>E-mail:</strong> {{ deal.client_email|default:"‚Äî" }}</p>

    {% if show_referrer %}
        <p><strong>Doporuƒçitel:</strong> {{ lead.referrer }}</p>
    {% endif %}
    {% if show_manager %}
        <p><strong>Mana≈æer:</strong> {{ lead.referrer_manager|default:"‚Äî" }}</p>
    {% endif %}
    {% if show_office %}
        <p><strong>Kancel√°≈ô:</strong> {{ lead.referrer_office|default:"‚Äî" }}</p>
    {% endif %}

    <hr>

    <p><strong>V√Ω≈°e √∫vƒõru:</strong> {{ deal.loan_amount }} Kƒç</p>
    <p><strong>Banka:</strong> {{ deal.get_bank_display }}</p>
    <p><strong>Nemovitost:</strong> {{ deal.get_property_type_display }}</p>
    <p><strong>Stav obchodu:</strong> <span class="badge">{{ deal.get_status_display }}</span></p>

    <hr>

    <p><strong>Provize makl√©≈ôe:</strong> {{ deal.commission_referrer|default:"‚Äî" }} Kƒç</p>

    {% if user.role != "REFERRER" %}
        <p><strong>Provize celkem:</strong> {{ deal.commission_total|default:"‚Äî" }} Kƒç</p>
    {% endif %}

    {% if user.role == "REFERRER_MANAGER" or user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
        <p><strong>Provize mana≈æer:</strong> {{ deal.commission_manager|default:"‚Äî" }} Kƒç</p>
    {% endif %}
    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
        <p><strong>Provize kancel√°≈ô:</strong> {{ deal.commission_office|default:"‚Äî" }} Kƒç</p>
    {% endif %}

    <hr>

    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <a href="{% url 'deal_edit' deal.pk %}" title="Upravit obchod">‚úèÔ∏è Upravit obchod</a>

        {% if can_manage_commission %}
            {% if deal.commission_status != "READY" and deal.commission_status != "PAID" %}
                <form method="post" action="{% url 'deal_commission_ready' deal.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit">‚úÖ P≈ôipraveno k vyplacen√≠</button>
                </form>
            {% else %}
                <form method="post" action="{% url 'deal_commission_paid' deal.pk 'referrer' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit">üí∏ Vyplaceno makl√©≈ôi</button>
                </form>

                {% if has_manager %}
                    <form method="post" action="{% url 'deal_commission_paid' deal.pk 'manager' %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">üí∏ Vyplaceno mana≈æerovi</button>
                    </form>
                {% endif %}

                {% if has_office %}
                    <form method="post" action="{% url 'deal_commission_paid' deal.pk 'office' %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">üí∏ Vyplaceno kancel√°≈ôi</button>
                    </form>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>

    <hr style="margin:16px 0;">

    <h3>P≈ôidat pozn√°mku</h3>
    <form method="post">
        {% csrf_token %}
        {{ note_form.text }}
        <div style="margin-top:8px;">
            <button type="submit">P≈ôidat pozn√°mku</button>
        </div>
    </form>

    <hr style="margin:16px 0;">

    <h3>Pozn√°mky</h3>
    {% if notes %}
        {% for note in notes %}
            <div class="card" style="box-shadow:none; border:1px solid #eee;">
                <strong>{{ note.author|default:"‚Äî" }}</strong>
                <small> ‚Äì {{ note.created_at|date:"d.m.Y H:i" }}</small>
                <div style="margin-top:6px;">{{ note.text|linebreaksbr }}</div>
            </div>
        {% endfor %}
    {% else %}
        <p>≈Ω√°dn√© pozn√°mky.</p>
    {% endif %}

    <hr style="margin:16px 0;">

    <h3>Historie</h3>
    {% if history %}
        <ul>
            {% for h in history %}
                <li>
                    <strong>{{ h.get_event_type_display }}</strong>
                    ‚Äì {{ h.created_at|date:"d.m.Y H:i" }}
                    {% if h.user %} ({{ h.user }}){% endif %}
                    {% if h.description %}<br><small>{{ h.description }}</small>{% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>≈Ω√°dn√° historie.</p>
    {% endif %}
</div>
{% endblock %}
