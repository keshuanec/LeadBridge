{% extends "base.html" %}

{% block title %}Detail leadu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ lead.client_name }}</h2>

    <p>
        <strong>Telefon:</strong> {{ lead.client_phone|default:"‚Äî" }}<br>
        <strong>E-mail:</strong> {{ lead.client_email|default:"‚Äî" }}<br>

        <strong>Doporuƒçitel:</strong>
        {% if lead.referrer.role == "ADVISOR" %}
            <a href="{% url 'advisor_detail' lead.referrer.pk %}">{{ lead.referrer.get_full_name }}</a>
        {% else %}
            <a href="{% url 'user_detail' lead.referrer.pk %}">{{ lead.referrer.get_full_name }}</a>
        {% endif %}<br>

        {% if lead.referrer_manager %}
            <strong>Mana≈æer:</strong>
            <a href="{% url 'user_detail' lead.referrer_manager.pk %}">{{ lead.referrer_manager.get_full_name }}</a><br>
        {% endif %}

        {% if lead.referrer_office and lead.referrer_office.owner %}
            <strong>Kancel√°≈ô:</strong>
            {{ lead.referrer_office.name }}
            (<a href="{% url 'user_detail' lead.referrer_office.owner.pk %}">{{ lead.referrer_office.owner.get_full_name }}</a>)<br>
        {% endif %}

        <strong>Poradce:</strong>
        {% if lead.advisor %}
            <a href="{% url 'advisor_detail' lead.advisor.pk %}">{{ lead.advisor.get_full_name }}</a>
        {% else %}
            ‚Äî
        {% endif %}<br><br>

        <strong>Stav leadu:</strong>
        {{ lead.get_communication_status_display }}<br>


        {% if lead.meeting_at %}
            <p><strong>Term√≠n sch≈Øzky:</strong>
                {{ lead.meeting_at|date:"d.m.Y H:i" }}
            </p>
        {% else %}
        <br>
        {% endif %}

        <strong>Popis situace:</strong><br>
        {{ lead.description|linebreaksbr|default:"(bez popisu)" }}
    </p>

    <p style="font-size: 13px; color: #666;">
        Vlo≈æeno: {{ lead.created_at|date:"d.m.Y H:i" }}<br>
        {% if lead.updated_at and lead.updated_at != lead.created_at %}
            Naposledy upraveno: {{ lead.updated_at|date:"d.m.Y H:i" }}<br>
        {% endif %}
    </p>

    <div style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px;">
        <a href="{% url 'lead_edit' lead.pk %}" class="btn btn-secondary">
            Upravit klienta
        </a>

        {% if can_schedule_meeting %}
            {% if lead.communication_status == "MEETING" %}
                {# Lead je ve stavu domluven√© sch≈Øzky - zobraz√≠me tlaƒç√≠tka pro v√Ωsledek #}
                <a href="{% url 'lead_meeting_completed' lead.pk %}"
                   class="btn btn-primary"
                   title="Sch≈Øzka probƒõhla">
                    ‚úÖ Sch≈Øzka probƒõhla
                </a>
                <a href="{% url 'lead_meeting_cancelled' lead.pk %}"
                   class="btn btn-danger"
                   title="Sch≈Øzka zru≈°ena">
                    ‚ùå Sch≈Øzka zru≈°ena
                </a>
            {% else %}
                {# Jin√Ω stav - zobraz√≠me tlaƒç√≠tko pro domluven√≠ sch≈Øzky #}
                <a href="{% url 'lead_schedule_meeting' lead.pk %}" class="btn btn-secondary" title="Domluvit sch≈Øzku">üìÖ Domluvit sch≈Øzku</a>
            {% endif %}
        {% endif %}

        {% if can_create_deal %}
            {% if lead.deal %}
                <a href="{% url 'deal_detail' lead.deal.pk %}" class="btn btn-primary" title="P≈ôej√≠t na obchod">üíº P≈ôej√≠t na obchod</a>
            {% else %}
                <a href="{% url 'deal_create_from_lead' lead.pk %}" class="btn btn-primary" title="Zalo≈æit obchod">‚ûï Zalo≈æit obchod</a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="card" id="note-form">
    <h3>P≈ôidat pozn√°mku</h3>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            {{ note_form.text }}
            {% if note_form.text.errors %}
                <div class="alert alert-error">{{ note_form.text.errors }}</div>
            {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">P≈ôidat pozn√°mku</button>
    </form>
</div>

<div class="card">
    <h3>Pozn√°mky</h3>
    {% if notes %}
        <ul style="list-style:none;padding-left:0;">
            {% for note in notes %}
                <li style="margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:6px;">
                    <div style="font-size:13px;color:#666;">
                        {{ note.created_at|date:"d.m.Y H:i" }}
                        ‚Äì {{ note.author.get_full_name|default:"(nezn√°m√Ω u≈æivatel)" }}
                    </div>
                    <div>{{ note.text|linebreaksbr }}</div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>≈Ω√°dn√© pozn√°mky.</p>
    {% endif %}
</div>

<div class="card">
    <h3>Historie leadu</h3>
    {% if history %}
        <ul style="list-style:none;padding-left:0;font-size:13px;">
            {% for event in history %}
                <li style="margin-bottom:6px;">
                    <strong>{{ event.created_at|date:"d.m.Y H:i" }}</strong>
                    ‚Äì {{ event.get_event_type_display }}
                    {% if event.user %}
                        ({{ event.user.get_full_name }})
                    {% endif %}
                    {% if event.description %}
                        ‚Äì {{ event.description }}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Zat√≠m ≈æ√°dn√© z√°znamy v historii.</p>
    {% endif %}
</div>
{% endblock %}
