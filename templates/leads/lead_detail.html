{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Detail leadu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ lead.client_name }}</h2>

    <p>
        <strong>Telefon:</strong> {% if lead.client_phone %}{{ lead.client_phone|format_phone }}{% else %}‚Äî{% endif %}<br>
        <strong>E-mail:</strong> {% if lead.client_email %}{{ lead.client_email|mailto }}{% else %}‚Äî{% endif %}<br>

        <strong>Doporuƒçitel:</strong>
        {% if lead.referrer.role == "ADVISOR" %}
            <a href="{% url 'advisor_detail' lead.referrer.pk %}">{{ lead.referrer.get_full_name }}</a>
        {% else %}
            <a href="{% url 'user_detail' lead.referrer.pk %}">{{ lead.referrer.get_full_name }}</a>
        {% endif %}<br>

        {% if lead.is_personal_contact %}
            <strong>Typ kontaktu:</strong>
            <span style="color: #666; font-style: italic;">Vlastn√≠ kontakt</span><br>
        {% else %}
            {% if lead.referrer_manager %}
                <strong>Mana≈æer:</strong>
                <a href="{% url 'user_detail' lead.referrer_manager.pk %}">{{ lead.referrer_manager.get_full_name }}</a><br>
            {% endif %}

            {% if lead.referrer_office and lead.referrer_office.owner %}
                <strong>Kancel√°≈ô:</strong>
                {{ lead.referrer_office.name }}
                (<a href="{% url 'user_detail' lead.referrer_office.owner.pk %}">{{ lead.referrer_office.owner.get_full_name }}</a>)<br>
            {% endif %}
        {% endif %}

        <strong>Poradce:</strong>
        {% if lead.advisor %}
            <a href="{% url 'advisor_detail' lead.advisor.pk %}">{{ lead.advisor.get_full_name }}</a>
        {% else %}
            ‚Äî
        {% endif %}<br><br>

        <strong>Stav leadu:</strong>
        {{ lead.get_communication_status_display }}<br>


        {% if lead.meeting_at %}
            <p><strong>Term√≠n sch≈Øzky:</strong>
                {{ lead.meeting_at|date:"d.m.Y H:i" }}
            </p>
        {% else %}
        <br>
        {% endif %}

        <strong>Popis situace:</strong><br>
        {{ lead.description|linebreaksbr|default:"(bez popisu)" }}
    </p>

    <p style="font-size: 13px; color: #666;">
        Vlo≈æeno: {{ lead.created_at|date:"d.m.Y H:i" }}<br>
        {% if lead.updated_at and lead.updated_at != lead.created_at %}
            Naposledy upraveno: {{ lead.updated_at|date:"d.m.Y H:i" }}<br>
        {% endif %}
    </p>

    <div style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px;">
        <a href="{% url 'lead_edit' lead.pk %}" class="btn btn-secondary">
            Upravit klienta
        </a>

        {% if can_schedule_meeting %}
            {% if lead.communication_status == "MEETING" %}
                {# Lead je ve stavu domluven√© sch≈Øzky - zobraz√≠me tlaƒç√≠tka pro v√Ωsledek #}
                <a href="{% url 'lead_meeting_completed' lead.pk %}"
                   class="btn btn-primary"
                   title="Sch≈Øzka probƒõhla">
                    ‚úÖ Sch≈Øzka probƒõhla
                </a>
                <a href="{% url 'lead_meeting_cancelled' lead.pk %}"
                   class="btn btn-danger"
                   title="Sch≈Øzka zru≈°ena">
                    ‚ùå Sch≈Øzka zru≈°ena
                </a>
            {% else %}
                {# Jin√Ω stav - zobraz√≠me tlaƒç√≠tko pro domluven√≠ sch≈Øzky #}
                <a href="{% url 'lead_schedule_meeting' lead.pk %}" class="btn btn-secondary" title="Domluvit sch≈Øzku">üìÖ Domluvit sch≈Øzku</a>
            {% endif %}
        {% endif %}

        {% if can_schedule_callback %}
            <a href="{% url 'schedule_callback' lead.pk %}" class="btn btn-secondary" title="Odlo≈æit hovor">üìû Odlo≈æit hovor</a>
        {% endif %}

        {% if can_create_deal %}
            <a href="{% url 'deal_create_from_lead' lead.pk %}" class="btn btn-primary">
                ‚ûï {% if deals %}Zalo≈æit dal≈°√≠ obchod{% else %}Zalo≈æit obchod{% endif %}
            </a>
        {% endif %}
    </div>
</div>

<!-- Sekce: Obchody leadu -->
{% if deals %}
<div class="card" style="margin-top: 20px;">
    <h3>Obchody ({{ deals.count }})</h3>
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Banka</th>
                    <th>V√Ω≈°e √∫vƒõru</th>
                    <th>Stav</th>
                    <th>Provize</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for deal in deals %}
                <tr {% if deal.is_personal_deal %}style="background-color: #f0f8ff;"{% endif %}>
                    <td>{{ deal.created_at|date:"d.m.Y" }}</td>
                    <td>{{ deal.get_bank_display }}</td>
                    <td>{{ deal.loan_amount|intcomma }} Kƒç</td>
                    <td>
                        <span class="badge">{{ deal.get_status_display }}</span>
                    </td>
                    <td>
                        {% if deal.is_personal_deal %}
                            <span class="badge" style="background-color: #ddd;">Bez provize</span>
                        {% elif deal.paid_referrer and deal.paid_manager and deal.paid_office %}
                            <span class="badge badge-ready">‚úÖ Vyplaceno</span>
                        {% elif deal.commission_status == "READY" %}
                            <span class="badge badge-ready">P≈ôipraveno</span>
                        {% else %}
                            <span class="badge">ƒåek√°</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'deal_detail' deal.pk %}" class="btn btn-sm btn-secondary">Detail</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="card" id="note-form">
    <h3>P≈ôidat pozn√°mku</h3>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            {{ note_form.text }}
            {% if note_form.text.errors %}
                <div class="alert alert-error">{{ note_form.text.errors }}</div>
            {% endif %}
        </div>
        <div class="form-group" style="margin-top:10px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                {{ note_form.is_private }}
                <span>{{ note_form.is_private.label }}</span>
            </label>
        </div>
        <button type="submit" class="btn btn-primary">P≈ôidat pozn√°mku</button>
    </form>
</div>

<div class="card">
    <h3>Pozn√°mky</h3>
    {% if notes %}
        <ul style="list-style:none;padding-left:0;">
            {% for note in notes %}
                <li style="margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:6px;{% if note.is_private %}background-color:#FFF9E6;border-left:3px solid #F39C12;padding-left:8px;{% endif %}">
                    <div style="font-size:13px;color:#666;">
                        {{ note.created_at|date:"d.m.Y H:i" }}
                        ‚Äì {{ note.author.get_full_name|default:"(nezn√°m√Ω u≈æivatel)" }}
                        {% if note.is_private %}
                            <span style="color:#F39C12;font-weight:600;margin-left:8px;">üîí Soukrom√°</span>
                        {% endif %}
                    </div>
                    <div>{{ note.text|linebreaksbr }}</div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>≈Ω√°dn√© pozn√°mky.</p>
    {% endif %}
</div>

<div class="card">
    <h3>Historie leadu</h3>
    {% if history %}
        <ul style="list-style:none;padding-left:0;font-size:13px;">
            {% for event in history %}
                <li style="margin-bottom:6px;">
                    <strong>{{ event.created_at|date:"d.m.Y H:i" }}</strong>
                    ‚Äì {{ event.get_event_type_display }}
                    {% if event.user %}
                        ({{ event.user.get_full_name }})
                    {% endif %}
                    {% if event.description %}
                        ‚Äì {{ event.description }}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Zat√≠m ≈æ√°dn√© z√°znamy v historii.</p>
    {% endif %}
</div>
{% endblock %}
