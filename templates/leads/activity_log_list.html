{% extends "base.html" %}
{% block title %}Aktivity u≈æivatel≈Ø{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä Log aktivit</h2>
    <p style="color: #666; font-size: 14px;">P≈ôehled v≈°ech aktivit u≈æivatel≈Ø v syst√©mu</p>

    {# Filtry #}
    <button type="button" class="btn btn-secondary filters-toggle">Zobrazit filtry</button>

    <form method="get" class="filter-form">
        <div class="filters-content">
            <div>
                <label style="font-size:12px; display:block;">U≈æivatel</label>
                <select name="user">
                    <option value="">‚Äì v≈°ichni ‚Äì</option>
                    {% for u in users %}
                        <option value="{{ u.id }}" {% if current_user_filter == u.id|stringformat:"s" %}selected{% endif %}>
                            {{ u.get_full_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label style="font-size:12px; display:block;">Typ aktivity</label>
                <select name="activity_type">
                    <option value="">‚Äì v≈°echny ‚Äì</option>
                    {% for code, label in activity_types %}
                        <option value="{{ code }}" {% if current_activity_type_filter == code %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label style="font-size:12px; display:block;">Datum od</label>
                <input type="date" name="date_from" value="{{ current_date_from }}">
            </div>

            <div>
                <label style="font-size:12px; display:block;">Datum do</label>
                <input type="date" name="date_to" value="{{ current_date_to }}">
            </div>

            <button type="submit" class="btn btn-primary">Filtrovat</button>
            <a href="{% url 'activity_log_list' %}" class="btn btn-secondary">Zru≈°it filtry</a>
        </div>
    </form>

    {% if activities %}
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
            Zobrazeno <strong>{{ total_count }}</strong> aktivit (max 500)
        </p>

        <div class="table-wrapper" style="margin-top: 20px;">
            <table class="activity-log-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">ƒåas</th>
                        <th style="width: 120px;">U≈æivatel</th>
                        <th style="width: 100px;">Typ aktivity</th>
                        <th style="width: 350px;">Popis</th>
                        <th style="width: 100px;">Lead/Obchod</th>
                        <th style="width: 110px;">IP adresa</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in activities %}
                        <tr>
                            <td title="{{ activity.timestamp }}">
                                {{ activity.timestamp|date:"d.m.Y H:i" }}
                            </td>
                            <td title="{% if activity.user %}{{ activity.user.get_full_name }}{% else %}Syst√©m{% endif %}">
                                {% if activity.user %}
                                    <a href="{% url 'user_detail' activity.user.pk %}">
                                        {{ activity.user.get_full_name }}
                                    </a>
                                {% else %}
                                    <span style="color: #999;">Syst√©m</span>
                                {% endif %}
                            </td>
                            <td title="{{ activity.get_activity_type_display }}">
                                <span class="badge" style="font-size: 11px;">
                                    {{ activity.get_activity_type_display }}
                                </span>
                            </td>
                            <td title="{{ activity.description }}">
                                {{ activity.description }}
                            </td>
                            <td>
                                {% if activity.lead %}
                                    <a href="{% url 'lead_detail' activity.lead.pk %}" title="Lead #{{ activity.lead.pk }}">
                                        Lead #{{ activity.lead.pk }}
                                    </a>
                                {% endif %}
                                {% if activity.deal %}
                                    <a href="{% url 'deal_detail' activity.deal.pk %}" title="Deal #{{ activity.deal.pk }}">
                                        Deal #{{ activity.deal.pk }}
                                    </a>
                                {% endif %}
                                {% if not activity.lead and not activity.deal %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td title="{{ activity.ip_address|default:'‚Äî' }}">
                                {{ activity.ip_address|default:"‚Äî" }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="margin-top: 20px;">≈Ω√°dn√© aktivity nebyly nalezeny.</p>
    {% endif %}
</div>

<style>
    .filters-content {
        display: none;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .filters-content.active {
        display: grid;
    }

    .filters-toggle {
        margin-bottom: 16px;
    }

    /* Fixn√≠ ≈°√≠≈ôky sloupc≈Ø s ellipsis */
    .activity-log-table {
        table-layout: fixed !important;
        width: 100% !important;
    }

    .activity-log-table td {
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 0 !important; /* Nutn√© pro fungov√°n√≠ ellipsis v table */
    }

    .activity-log-table th {
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }

    /* Zachovat norm√°ln√≠ styling pro specifick√© sloupce */
    .activity-log-table td:first-child,
    .activity-log-table td:last-child {
        font-size: 12px;
        color: #666;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.querySelector('.filters-toggle');
    const filtersContent = document.querySelector('.filters-content');

    if (toggleBtn && filtersContent) {
        toggleBtn.addEventListener('click', function() {
            filtersContent.classList.toggle('active');
            if (filtersContent.classList.contains('active')) {
                toggleBtn.textContent = 'Skr√Ωt filtry';
            } else {
                toggleBtn.textContent = 'Zobrazit filtry';
            }
        });

        // Auto-show filters if any filter is applied
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('user') || urlParams.get('activity_type') || urlParams.get('date_from') || urlParams.get('date_to')) {
            filtersContent.classList.add('active');
            toggleBtn.textContent = 'Skr√Ωt filtry';
        }
    }
});
</script>
{% endblock %}
