{% extends "base.html" %}
{% block title %}Obchody{% endblock %}

{% block content %}
<style>
    /* Kompaktn√≠ sloupce v tabulce obchod≈Ø */
    .table-wrapper {
        overflow-x: auto;
        transition: all 0.3s ease;
    }

    .table-wrapper > table.deals-table {
        table-layout: fixed !important;
        width: 100% !important;
        transition: width 0.3s ease;
    }

    .table-wrapper > table.deals-table.notes-visible {
        width: calc(100% + 400px) !important;
    }

    /* Stav obchodu - pevn√° mal√° ≈°√≠≈ôka */
    .table-wrapper > table.deals-table .status-deal-col {
        width: 85px !important;
        white-space: normal !important;
        padding: 6px 4px !important;
        line-height: 1.3 !important;
        overflow: hidden !important;
    }

    /* Klient */
    .table-wrapper > table.deals-table .client-col {
        width: 90px !important;
        white-space: normal !important;
        padding: 6px 8px !important;
        line-height: 1.3 !important;
    }

    /* V√Ω≈°e √∫vƒõru */
    .table-wrapper > table.deals-table .loan-col {
        width: 90px !important;
        white-space: nowrap !important;
        padding: 6px 8px !important;
    }

    .table-wrapper > table.deals-table td {
        font-size: 13px !important;
        padding: 6px 8px !important;
        white-space: normal !important;
        line-height: 1.3 !important;
    }

    .table-wrapper > table.deals-table th {
        font-size: 12px !important;
        padding: 8px 8px !important;
        white-space: normal !important;
        line-height: 1.3 !important;
    }

    .table-wrapper > table.deals-table .badge {
        font-size: 10px !important;
        padding: 3px 5px !important;
        white-space: normal !important;
    }

    /* √özk√© sloupce proviz√≠ */
    .table-wrapper > table.deals-table .commission-col {
        width: 70px !important;
        font-size: 12px !important;
        padding: 6px 4px !important;
        white-space: nowrap !important;
        vertical-align: top !important;
        overflow: hidden !important;
    }

    .table-wrapper > table.deals-table .commission-col .amount {
        display: block;
        line-height: 1.3;
    }

    .table-wrapper > table.deals-table .commission-col .badge {
        display: block;
        margin-top: 3px;
        width: fit-content;
    }

    /* Sloupce s jm√©ny osob */
    .table-wrapper > table.deals-table .person-col {
        width: 70px !important;
        white-space: normal !important;
        font-size: 13px !important;
        padding: 6px 8px !important;
        line-height: 1.3 !important;
    }

    /* Sloupec Vytvo≈ôeno */
    .table-wrapper > table.deals-table .date-col {
        width: 85px !important;
        white-space: nowrap !important;
    }

    /* Sloupec Stav provize */
    .table-wrapper > table.deals-table .status-col {
        width: 110px !important;
        white-space: normal !important;
        line-height: 1.3 !important;
    }

    /* Sloupec Pozn√°mka */
    .table-wrapper > table.deals-table .note-col {
        transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
        vertical-align: top !important;
        max-width: 400px !important;
        overflow: hidden !important;
    }

    .table-wrapper > table.deals-table .note-col.note-col-hidden {
        width: 0 !important;
        padding: 0 !important;
        opacity: 0;
        border: none !important;
    }

    .table-wrapper > table.deals-table .note-col:not(.note-col-hidden) {
        width: 400px !important;
        padding: 6px 8px !important;
        opacity: 1;
    }

    /* Vnit≈ôn√≠ div pro o≈ô√≠znut√≠ textu pozn√°mky */
    .table-wrapper > table.deals-table .note-col .note-content {
        font-size: 12px !important;
        line-height: 1.3 !important;
        max-height: 2.6em !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        width: 100% !important;
    }

    /* Soukrom√° pozn√°mka - ≈ælut√© pozad√≠ a oran≈æov√Ω border */
    .table-wrapper > table.deals-table .note-col .note-content.private-note {
        background-color: #FFF9E6;
        border-left: 3px solid #F39C12;
        padding-left: 6px;
    }

    .table-wrapper > table.deals-table .note-col .note-content .private-badge {
        color: #F39C12;
        font-weight: 600;
        margin-right: 4px;
    }

    /* Barevn√© podbarven√≠ ≈ô√°dk≈Ø podle statusu */
    .deal-row-completed {
        background-color: #e8f5e9 !important; /* Lehce zelen√° */
    }

    .deal-row-failed {
        background-color: #ffebee !important; /* Lehce ƒçerven√° */
    }

    .deal-row-completed:hover,
    .deal-row-failed:hover,
    .deal-row-pending:hover {
        opacity: 0.9;
    }
</style>

<div class="card">
    <h2>Obchody</h2>

{# Tlaƒç√≠tka pro zobrazen√≠ filtr≈Ø a pozn√°mek + akƒçn√≠ tlaƒç√≠tka filtr≈Ø #}
<div class="toggle-buttons-row">
    <button type="button" class="btn btn-secondary filters-toggle">Zobrazit filtry</button>
    <button type="button" class="btn btn-secondary" id="toggleNotesBtn">Zobrazit pozn√°mky</button>
    <button type="button" class="btn btn-primary filter-submit-btn" style="display: none;">Filtrovat</button>
    {% if current_status or current_commission or current_referrer or current_advisor or current_manager or current_office %}
    <a href="{% url 'deals_list' %}" class="btn btn-secondary filter-reset-btn">Zru≈°it filtry</a>
    {% endif %}
</div>

{# Filtry POD tlaƒç√≠tky #}
<form method="get" class="filter-form" id="filterForm">
    <div class="filters-content">
    {% if "status" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Stav obchodu</label>
            <select name="status">
                <option value="">‚Äì v≈°echny ‚Äì</option>
                {% for code, label in status_choices %}
                    <option value="{{ code }}" {% if current_status == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "commission" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Stav provize</label>
            <select name="commission">
                <option value="">‚Äì v≈°echny ‚Äì</option>
                {% for code, label in commission_choices %}
                    <option value="{{ code }}" {% if current_commission == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "referrer" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Doporuƒçitel</label>
            <select name="referrer">
                <option value="">‚Äì v≈°ichni ‚Äì</option>
                {% for r in referrer_options %}
                    <option value="{{ r.id }}" {% if current_referrer == r.id|stringformat:"s" %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "advisor" in allowed and show_advisor_col %}
        <div>
            <label style="font-size:12px; display:block;">Poradce</label>
            <select name="advisor">
                <option value="">‚Äì v≈°ichni ‚Äì</option>
                {% for a in advisor_options %}
                    <option value="{{ a.id }}" {% if current_advisor == a.id|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "manager" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Mana≈æer</label>
            <select name="manager">
                <option value="">‚Äì v≈°ichni ‚Äì</option>
                <option value="__none__" {% if current_manager == "__none__" %}selected{% endif %}>‚Äî bez mana≈æera ‚Äî</option>
                {% for m in manager_options %}
                    <option value="{{ m.id }}" {% if current_manager == m.id|stringformat:"s" %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if "office" in allowed %}
        <div>
            <label style="font-size:12px; display:block;">Kancel√°≈ô</label>
            <select name="office">
                <option value="">‚Äì v≈°echny ‚Äì</option>
                <option value="__none__" {% if current_office == "__none__" %}selected{% endif %}>‚Äî bez kancel√°≈ôe ‚Äî</option>
                {% for o in office_options %}
                    <option value="{{ o.id }}" {% if current_office == o.id|stringformat:"s" %}selected{% endif %}>{{ o.name }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <input type="hidden" name="sort" value="{{ current_sort }}">
    <input type="hidden" name="dir" value="{{ current_dir }}">
    </div>
</form>

{# V√Ωsledky #}
    {% if deals %}
        <div class="table-wrapper">
        <table class="deals-table">
            <thead>
                <tr>
                    <th class="status-deal-col">
                        <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=status&dir={% if current_sort == 'status' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Stav obchodu
                            {% if current_sort == 'status' %}
                                {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th style="width: 60px;">Typ</th>
                    <th class="client-col">
                        <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=client&dir={% if current_sort == 'client' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Klient
                            {% if current_sort == 'client' %}
                                {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th class="loan-col">
                        <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=loan_amount&dir={% if current_sort == 'loan_amount' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            V√Ω≈°e √∫vƒõru
                            {% if current_sort == 'loan_amount' %}
                                {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    <th class="note-col note-col-hidden">Pozn√°mka</th>

                    {% if show_referrer_col %}
                        <th class="person-col">
                            <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=referrer&dir={% if current_sort == 'referrer' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                Doporuƒçitel
                                {% if current_sort == 'referrer' %}
                                    {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                                {% endif %}
                            </a>
                        </th>
                    {% endif %}

                    {% if show_manager_col %}
                        <th class="person-col">
                            <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=manager&dir={% if current_sort == 'manager' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                Mana≈æer
                                {% if current_sort == 'manager' %}
                                    {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                                {% endif %}
                            </a>
                        </th>
                    {% endif %}

                    {% if show_office_col %}
                        <th class="person-col">
                            <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=office&dir={% if current_sort == 'office' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                Kancel√°≈ô
                                {% if current_sort == 'office' %}
                                    {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                                {% endif %}
                            </a>
                        </th>
                    {% endif %}

                    <th class="date-col">
                        <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=created_at&dir={% if current_sort == 'created_at' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Vytvo≈ôeno
                            {% if current_sort == 'created_at' %}
                                {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th class="status-col">
                        <a href="?{% if qs_keep %}{{ qs_keep }}&{% endif %}sort=commission&dir={% if current_sort == 'commission' and current_dir == 'asc' %}desc{% else %}asc{% endif %}">
                            Stav provize
                            {% if current_sort == 'commission' %}
                                {% if current_dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>

                    {# Provize - role-based zobrazen√≠ #}
                    <th class="commission-col">Prov. makl.</th>
                    {% if user.role != "REFERRER" %}
                        <th class="commission-col">Prov. man.</th>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <th class="commission-col">Prov. kanc.</th>
                    {% endif %}
                    {% if user.role == "ADVISOR" or user.is_superuser %}
                        <th class="commission-col">Prov. porad.</th>
                    {% endif %}

                    {# Sloupec Poradce pro admin advisors #}
                    {% if user.role == "ADVISOR" and user.has_admin_access %}
                        <th class="person-col">Poradce</th>
                    {% endif %}

                </tr>
            </thead>
            <tbody>
            {% for d in deals %}
                <tr class="{% if d.status == 'FAILED' %}deal-row-failed{% elif d.status == 'SIGNED' or d.status == 'SIGNED_NO_PROPERTY' or d.status == 'DRAWN' %}deal-row-completed{% else %}deal-row-pending{% endif %}">
                    <td class="status-deal-col"><a href="{% url 'deal_detail' d.pk %}"><span class="badge">{{ d.get_status_display }}</span></a></td>
                    <td style="text-align: center;">
                        {% if d.is_personal_deal %}
                            <span class="badge" style="background-color: #4a90e2; color: white;" title="Vlastn√≠ obchod">üë§</span>
                        {% else %}
                            <span class="badge" style="background-color: #50c878; color: white;" title="Provizovan√Ω obchod">üíº</span>
                        {% endif %}
                    </td>
                    <td class="client-col"><a href="{% url 'deal_detail' d.pk %}">{{ d.client_name }}</a></td>
                    <td class="loan-col">{{ d.loan_amount|floatformat:0 }} Kƒç</td>

                    <td class="note-col note-col-hidden">
                        <div class="note-content{% if d.last_note_is_private %} private-note{% endif %}">
                            {% if d.last_note_text %}
                                {% if d.last_note_is_private %}<span class="private-badge">üîí</span>{% endif %}{{ d.last_note_text }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                    </td>

                    {% if show_referrer_col %}
                        <td class="person-col">
                            {% if d.referrer_id %}
                                <a href="{% url 'user_detail' d.referrer_id %}">{{ d.referrer_name }}</a>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                    {% endif %}

                    {% if show_manager_col %}
                        <td class="person-col">
                            {% if d.lead.is_personal_contact %}
                                <span style="color: #666; font-style: italic;">Vlastn√≠ kontakt</span>
                            {% elif d.manager_id %}
                                <a href="{% url 'user_detail' d.manager_id %}">{{ d.manager_name }}</a>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                    {% endif %}

                    {% if show_office_col %}
                        <td class="person-col">
                            {% if d.lead.is_personal_contact %}
                                <span style="color: #666; font-style: italic;">Vlastn√≠ kontakt</span>
                            {% elif d.office_owner_id %}
                                <a href="{% url 'user_detail' d.office_owner_id %}">{{ d.office_name }}</a>
                            {% elif d.office_name %}
                                {{ d.office_name }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                    {% endif %}

                    <td class="date-col">{{ d.created_at|date:"d.m.Y" }}</td>
                    <td class="status-col">
                    {% if d.status != "SIGNED" and d.status != "SIGNED_NO_PROPERTY" and d.status != "DRAWN" %}
                        {# Obchod je≈°tƒõ nen√≠ podeps√°n #}
                        Nedokonƒçeno
                    {% elif d.user_commissions_paid %}
                        {# V≈°echny relevantn√≠ provize vyplaceny (podle role u≈æivatele) #}
                        <span class="badge badge-ready">Vyplaceno</span>
                    {% else %}
                        {# Obchod podeps√°n/naƒçerp√°n, ale provize ƒçekaj√≠ #}
                        <span class="badge badge-warning">ƒåek√°n√≠ na provizi</span>
                    {% endif %}
                    </td>

                    {# Zobrazen√≠ proviz√≠ - role-based #}
                    <td class="commission-col">
                        <span class="amount">{{ d.calculated_commission_referrer|floatformat:0 }} Kƒç</span>
                        {% if d.paid_referrer %}
                            <span class="badge badge-ready">paid</span>
                        {% endif %}
                    </td>
                    {% if user.role != "REFERRER" %}
                    <td class="commission-col">
                        {% if d.calculated_commission_manager > 0 %}
                            <span class="amount">{{ d.calculated_commission_manager|floatformat:0 }} Kƒç</span>
                            {% if d.paid_manager %}
                                <span class="badge badge-ready">paid</span>
                            {% endif %}
                        {% else %}‚Äî{% endif %}
                    </td>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                    <td class="commission-col">
                        {% if d.calculated_commission_office > 0 %}
                            <span class="amount">{{ d.calculated_commission_office|floatformat:0 }} Kƒç</span>
                            {% if d.paid_office %}
                                <span class="badge badge-ready">paid</span>
                            {% endif %}
                        {% else %}‚Äî{% endif %}
                    </td>
                    {% endif %}
                    {% if user.role == "ADVISOR" or user.is_superuser %}
                        <td class="commission-col">
                            {% if d.calculated_commission_advisor > 0 %}
                                <span class="amount">{{ d.calculated_commission_advisor|floatformat:0 }} Kƒç</span>
                            {% else %}‚Äî{% endif %}
                        </td>
                    {% endif %}

                    {# Sloupec Poradce pro admin advisors #}
                    {% if user.role == "ADVISOR" and user.has_admin_access %}
                        <td class="person-col">
                            {% if d.advisor_id %}
                                <a href="{% url 'advisor_detail' d.advisor_id %}">{{ d.advisor_name }}</a>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                    {% endif %}


                </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    {% else %}
        <p>Zat√≠m nem√°te ≈æ√°dn√© obchody.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggleNotesBtn');
    const noteCols = document.querySelectorAll('.note-col');
    const dealsTable = document.querySelector('.deals-table');
    let notesVisible = false;

    if (toggleBtn && dealsTable) {
        toggleBtn.addEventListener('click', function() {
            notesVisible = !notesVisible;

            noteCols.forEach(function(col) {
                if (notesVisible) {
                    col.classList.remove('note-col-hidden');
                } else {
                    col.classList.add('note-col-hidden');
                }
            });

            if (notesVisible) {
                dealsTable.classList.add('notes-visible');
            } else {
                dealsTable.classList.remove('notes-visible');
            }

            toggleBtn.textContent = notesVisible ? 'Skr√Ωt pozn√°mky' : 'Zobrazit pozn√°mky';
        });
    }
});
</script>
{% endblock %}
