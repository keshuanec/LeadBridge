{% extends "base.html" %}
{% block title %}Obchody{% endblock %}

{% block content %}
<div class="card">
    <h2>Obchody</h2>

    {% if deals %}
        <table>
            <thead>
                <tr>
                    <th>Stav obchodu</th>
                    <th>Klient</th>
                    <th>Výše úvěru</th>

                    {# Provize - role-based zobrazení #}
                    <th>Provize makléře</th>
                    {% if user.role != "REFERRER" %}
                        <th>Provize manažera</th>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <th>Provize kanceláře</th>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.role == "REFERRER_MANAGER" or user.is_superuser %}
                        <th>Provize celkem</th>
                    {% endif %}

                    {% if user.role == "REFERRER_MANAGER" or user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <th>Doporučitel</th>
                    {% endif %}

                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <th>Manažer</th>
                    {% endif %}

                    {% if user.role == "ADVISOR" or user.is_superuser %}
                        <th>Kancelář</th>
                    {% endif %}

                    <th>Vytvořeno</th>
                    <th>Stav provize</th>
                </tr>
            </thead>
            <tbody>
            {% for d in deals %}
                <tr>
                    <td><a href="{% url 'deal_detail' d.pk %}"><span class="badge">{{ d.get_status_display }}</span></a></td>
                    <td><a href="{% url 'deal_detail' d.pk %}">{{ d.client_name }}</a></td>
                    <td>{{ d.loan_amount|floatformat:0 }} Kč</td>

                    {# Zobrazení provizí - role-based #}
                    <td>{{ d.calculated_commission_referrer|floatformat:0 }} Kč</td>
                    {% if user.role != "REFERRER" %}
                        <td>{% if d.calculated_commission_manager > 0 %}{{ d.calculated_commission_manager|floatformat:0 }} Kč{% else %}—{% endif %}</td>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <td>{% if d.calculated_commission_office > 0 %}{{ d.calculated_commission_office|floatformat:0 }} Kč{% else %}—{% endif %}</td>
                    {% endif %}
                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.role == "REFERRER_MANAGER" or user.is_superuser %}
                        <td>
                            {% if d.calculated_commission_office > 0 %}
                                {# Deal má kancelář → celkem vidí jen OFFICE, ADVISOR, superuser #}
                                {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                                    {{ d.calculated_commission_total|floatformat:0 }} Kč
                                {% else %}
                                    —
                                {% endif %}
                            {% elif d.calculated_commission_manager > 0 %}
                                {# Deal má manažera (ale ne kancelář) → celkem vidí jen REFERRER_MANAGER, ADVISOR, superuser #}
                                {% if user.role == "REFERRER_MANAGER" or user.role == "ADVISOR" or user.is_superuser %}
                                    {{ d.calculated_commission_total|floatformat:0 }} Kč
                                {% else %}
                                    —
                                {% endif %}
                            {% else %}
                                {# Deal nemá ani manažera ani kancelář → nikdo nevidí #}
                                —
                            {% endif %}
                        </td>
                    {% endif %}

                    {% if user.role == "REFERRER_MANAGER" or user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <td>{{ d.referrer_name }}</td>
                    {% endif %}

                    {% if user.role == "OFFICE" or user.role == "ADVISOR" or user.is_superuser %}
                        <td>{{ d.manager_name|default:"—" }}</td>
                    {% endif %}

                    {% if user.role == "ADVISOR" or user.is_superuser %}
                        <td>{{ d.office_name|default:"—" }}</td>
                    {% endif %}

                    <td>{{ d.created_at|date:"d.m.Y H:i" }}</td>
                    <td>
                    {% if d.commission_status == "PENDING" %}
                        {{ d.get_commission_status_display }}
                    {% elif d.commission_status == "READY" or d.commission_status == "PAID" %}
                        {# Kontrola, jestli jsou všichni vyplacení #}
                        {% if d.all_commissions_paid %}
                            {# Všichni vyplacení #}
                            Provize vyplacena
                        {% else %}
                            {# Ještě někdo není vyplacený #}
                            <span class="badge badge-ready">
                                Připraveno k vyplacení
                            </span>
                            <div style="font-size:12px; margin-top:6px;">
                                <div style="{% if d.paid_referrer %}color: #2e7d32;{% else %}color: #999;{% endif %}">
                                    makléř
                                </div>
                                {% if d.manager_name %}
                                    <div style="{% if d.paid_manager %}color: #2e7d32;{% else %}color: #999;{% endif %}">
                                        manažer
                                    </div>
                                {% endif %}
                                {% if d.office_name %}
                                    <div style="{% if d.paid_office %}color: #2e7d32;{% else %}color: #999;{% endif %}">
                                        kancelář
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Zatím nemáte žádné obchody.</p>
    {% endif %}
</div>
{% endblock %}
